<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>hobbifinder</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@1,700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.12);border-radius:4px}
:root{--bg:#0a0a0f;--surface:#13131a;--surface2:#1c1c27;--border:rgba(255,255,255,0.07);--text:#f0f0f0;--muted:rgba(255,255,255,0.35);--accent:#FF6B6B;--accent2:#FF8C42;--green:#22c55e;--sidebar:240px;--right:290px}
body{background:var(--bg);font-family:'DM Sans',sans-serif;color:var(--text);min-height:100vh}
.hidden{display:none!important}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.22)}}
@keyframes spin{to{transform:rotate(360deg)}}
.spin{display:inline-block;width:18px;height:18px;border:2px solid rgba(255,255,255,0.25);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px}

/* AUTH */
#authWall{position:fixed;inset:0;background:var(--bg);z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
.auth-split{display:flex;width:100%;max-width:900px;min-height:540px;border-radius:24px;overflow:hidden;border:1px solid var(--border);box-shadow:0 24px 80px rgba(0,0,0,0.5)}
.auth-brand{flex:1;background:linear-gradient(145deg,#1a0a0f,#0f0a1a,#0a0f1a);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px;position:relative;overflow:hidden}
.auth-brand::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 30% 40%,rgba(255,107,107,0.2),transparent 60%),radial-gradient(ellipse at 70% 70%,rgba(100,80,255,0.13),transparent 60%)}
.auth-brand-logo{font-family:'Playfair Display',serif;font-style:italic;font-weight:700;font-size:44px;background:linear-gradient(135deg,#FF6B6B,#FF8C42);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:12px;position:relative;z-index:1}
.auth-brand-tag{font-size:16px;color:rgba(255,255,255,0.45);text-align:center;line-height:1.7;position:relative;z-index:1;max-width:240px}
.auth-preview{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:28px;width:190px;opacity:.65;position:relative;z-index:1}
.auth-preview img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px}
.auth-form-side{width:380px;flex-shrink:0;background:var(--surface);padding:44px 38px;display:flex;flex-direction:column;justify-content:center}
.auth-title{font-size:24px;font-weight:700;margin-bottom:4px}
.auth-sub{font-size:14px;color:var(--muted);margin-bottom:24px}
.auth-tabs{display:flex;background:var(--surface2);border-radius:12px;padding:4px;margin-bottom:22px}
.auth-tab{flex:1;padding:9px;border-radius:8px;border:none;background:none;color:var(--muted);font-family:inherit;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s}
.auth-tab.active{background:var(--bg);color:var(--text);font-weight:600}
.auth-field{margin-bottom:13px}
.auth-field label{display:block;font-size:11px;font-weight:600;color:var(--muted);margin-bottom:5px;letter-spacing:.5px;text-transform:uppercase}
.auth-input{width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:var(--text);outline:none;border-radius:11px;padding:11px 13px;font-size:14px;font-family:inherit;transition:border-color .2s}
.auth-input:focus{border-color:rgba(255,107,107,0.5);background:rgba(255,107,107,0.04)}
.auth-input::placeholder{color:var(--muted)}
.auth-hobby-row{display:flex;flex-wrap:wrap;gap:6px}
.auth-hobby-chip{padding:5px 11px;border-radius:14px;font-size:11px;cursor:pointer;font-weight:500;transition:all .15s;font-family:inherit;border:1px solid}
.auth-submit{width:100%;padding:12px;border-radius:12px;border:none;background:linear-gradient(135deg,#FF6B6B,#FF8C42);color:#fff;font-weight:700;font-size:15px;cursor:pointer;font-family:inherit;box-shadow:0 4px 18px rgba(255,107,107,0.35);transition:transform .2s;margin-top:8px;display:flex;align-items:center;justify-content:center;gap:6px}
.auth-submit:hover:not(:disabled){transform:translateY(-2px)}
.auth-submit:disabled{background:rgba(255,255,255,0.1);color:var(--muted);cursor:not-allowed;box-shadow:none;transform:none}
.auth-error{background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.25);border-radius:10px;padding:10px 13px;font-size:13px;color:#fca5a5;margin-bottom:13px;display:none;line-height:1.5}
.auth-fine{font-size:11px;color:rgba(255,255,255,0.18);margin-top:12px;line-height:1.6;text-align:center}
@media(max-width:700px){.auth-split{flex-direction:column;max-width:420px;min-height:auto}.auth-brand{padding:32px;flex:none}.auth-brand-tag,.auth-preview{display:none}.auth-form-side{width:100%;padding:28px 24px}}

/* APP */
#appShell{display:none}
#layout{display:flex;min-height:100vh;max-width:1280px;margin:0 auto}
#sidebar{width:var(--sidebar);flex-shrink:0;position:sticky;top:0;height:100vh;display:flex;flex-direction:column;padding:24px 12px;border-right:1px solid var(--border);overflow-y:auto}
.sidebar-logo{font-family:'Playfair Display',serif;font-style:italic;font-weight:700;font-size:26px;background:linear-gradient(135deg,#FF6B6B,#FF8C42);-webkit-background-clip:text;-webkit-text-fill-color:transparent;padding:0 10px 28px}
.nav-item{display:flex;align-items:center;gap:13px;padding:11px 14px;border-radius:14px;cursor:pointer;font-size:15px;font-weight:500;color:var(--muted);transition:all .2s;border:none;background:none;width:100%;font-family:inherit;position:relative;text-align:left}
.nav-item:hover{background:rgba(255,255,255,0.06);color:var(--text)}
.nav-item.active{background:rgba(255,107,107,0.12);color:var(--accent);font-weight:600}
.ni-icon{font-size:20px;width:24px;text-align:center;flex-shrink:0}
.ni-badge{background:var(--accent);color:#fff;font-size:10px;font-weight:700;border-radius:10px;padding:2px 7px;margin-left:auto}
.sidebar-divider{height:1px;background:var(--border);margin:12px 10px}
.sidebar-post-btn{margin:8px 10px 0;padding:13px;border-radius:14px;border:none;background:linear-gradient(135deg,#FF6B6B,#FF8C42);color:#fff;font-weight:700;font-size:15px;cursor:pointer;font-family:inherit;width:calc(100% - 20px);box-shadow:0 4px 15px rgba(255,107,107,0.3);transition:transform .2s}
.sidebar-post-btn:hover{transform:translateY(-2px)}
.sidebar-spacer{flex:1}
.sidebar-user{display:flex;align-items:center;gap:10px;padding:12px 10px;border-radius:14px;cursor:pointer;transition:background .2s}
.sidebar-user:hover{background:rgba(255,255,255,0.06)}
#sidebarAva{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--accent)}
.sidebar-user-name{font-weight:600;font-size:13px}
.sidebar-user-sub{font-size:11px;color:var(--muted)}
#center{flex:1;min-width:0;border-right:1px solid var(--border)}
.center-header{padding:15px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(10,10,15,0.96);backdrop-filter:blur(14px);z-index:50;display:flex;align-items:center;gap:12px}
.center-title{font-weight:700;font-size:18px;flex:1}
.center-search{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:var(--text);outline:none;border-radius:22px;padding:8px 14px 8px 36px;font-size:13px;font-family:inherit;transition:all .2s;width:190px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='rgba(255,255,255,0.28)' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.099zm-5.242 1.656a5.5 5.5 0 1 1 0-11 5.5 5.5 0 0 1 0 11z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:10px center;background-size:14px}
.center-search::placeholder{color:var(--muted)}
.center-search:focus{border-color:rgba(255,107,107,0.5);width:240px}
.chips-bar{display:flex;gap:7px;padding:12px 20px;overflow-x:auto;scrollbar-width:none;border-bottom:1px solid var(--border)}
.chips-bar::-webkit-scrollbar{display:none}
.chip{padding:5px 14px;border-radius:20px;font-size:12px;font-weight:500;white-space:nowrap;cursor:pointer;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.05);color:#fff;font-family:inherit;transition:all .18s}
.chip:hover{transform:scale(1.05)}
.chip.all.active{background:linear-gradient(135deg,#FF6B6B,#FF8C42);border-color:transparent}
.screen{display:none;animation:fadeIn .2s ease}.screen.active{display:block}
.grid-wrap{padding:4px}
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:3px}
.grid-cell{position:relative;aspect-ratio:1/1;overflow:hidden;cursor:pointer;border-radius:4px;background:#1c1c27;animation:fadeIn .3s ease both}
.grid-cell img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .3s}
.grid-cell:hover img{transform:scale(1.07)}
.grid-overlay{position:absolute;inset:0;background:rgba(0,0,0,0);display:flex;align-items:center;justify-content:center;gap:18px;transition:background .2s}
.grid-cell:hover .grid-overlay{background:rgba(0,0,0,0.5)}
.grid-stat{color:#fff;font-size:14px;font-weight:700;opacity:0;transform:translateY(4px);transition:opacity .18s,transform .18s}
.grid-cell:hover .grid-stat{opacity:1;transform:translateY(0)}
.grid-dot{position:absolute;top:7px;right:7px;width:9px;height:9px;border-radius:50%;border:1.5px solid rgba(255,255,255,0.6)}
.empty-state{text-align:center;padding:80px 20px;color:var(--muted);animation:fadeIn .3s ease}
.empty-state .big{font-size:52px;margin-bottom:14px}
.loading-grid{text-align:center;padding:60px 20px;color:var(--muted)}
#right{width:var(--right);flex-shrink:0;padding:20px 16px;position:sticky;top:0;height:100vh;overflow-y:auto}
.ad-box{background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px dashed rgba(255,255,255,0.12);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;width:100%;text-align:center}
.ad-lbl{font-size:9px;letter-spacing:2px;color:rgba(255,255,255,0.22);text-transform:uppercase}
.ad-dim{font-size:11px;color:rgba(255,255,255,0.11);font-family:monospace}
.ad-rect{height:260px}.ad-sq{height:200px}
.widget{background:var(--surface);border-radius:16px;padding:16px;margin-bottom:16px;border:1px solid var(--border)}
.widget-title{font-size:13px;font-weight:700;margin-bottom:14px}
.trend-tag{display:flex;align-items:center;gap:8px;padding:8px 0;cursor:pointer;border-bottom:1px solid var(--border);transition:opacity .15s}
.trend-tag:last-child{border-bottom:none}.trend-tag:hover{opacity:.75}
.tt-rank{font-size:11px;color:var(--muted);width:18px}.tt-name{font-size:13px;font-weight:600;flex:1}.tt-count{font-size:11px;color:var(--muted)}
.sec-title{font-size:12px;font-weight:600;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;padding:20px 20px 10px}
.explore-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:0 20px 20px}
.etag-card{display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:14px;cursor:pointer;transition:transform .2s;border:1px solid transparent}
.etag-card:hover{transform:translateY(-2px)}
.etag-icon{font-size:24px;flex-shrink:0}.etag-name{font-size:14px;font-weight:700}.etag-count{font-size:12px;opacity:.65}
.trend-grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:3px;padding:0 4px 20px}
.trend-cell{position:relative;aspect-ratio:1/1;overflow:hidden;cursor:pointer;border-radius:4px}
.trend-cell img{width:100%;height:100%;object-fit:cover;transition:transform .3s}
.trend-cell:hover img{transform:scale(1.07)}
.trend-lbl{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.75));padding:20px 8px 8px;font-size:12px;font-weight:600;color:#fff}
.hobby-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:0 20px 20px}
.hcard{border-radius:16px;padding:20px 18px;cursor:pointer;transition:transform .2s,box-shadow .2s;border:1px solid transparent}
.hcard:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.4)}
.hcard-icon{font-size:30px;margin-bottom:10px}.hcard-name{font-size:15px;font-weight:700;margin-bottom:3px}.hcard-count{font-size:12px;opacity:.65}
.msg-empty{text-align:center;padding:48px 20px;color:var(--muted)}
.msg-empty .big{font-size:44px;margin-bottom:12px}
.notif-item{display:flex;align-items:flex-start;gap:12px;padding:16px 20px;cursor:pointer;transition:background .15s;border-bottom:1px solid var(--border)}
.notif-item:hover{background:rgba(255,255,255,0.04)}
.notif-ava{width:44px;height:44px;border-radius:50%;object-fit:cover;flex-shrink:0}
.notif-text{font-size:14px;line-height:1.5;flex:1}.notif-text strong{font-weight:600}
.notif-time{font-size:12px;color:var(--muted);margin-top:3px}
.profile-cover{height:180px;background:linear-gradient(135deg,rgba(255,107,107,.3),rgba(255,140,66,.2),rgba(100,100,200,.2))}
.profile-info{padding:0 24px}
.profile-pic-wrap{margin-top:-44px;margin-bottom:12px;position:relative;display:inline-block}
.profile-pic{width:88px;height:88px;border-radius:50%;object-fit:cover;border:4px solid var(--bg);cursor:pointer;display:block;transition:opacity .2s}
.profile-pic:hover{opacity:.8}
.profile-name{font-weight:700;font-size:20px;margin-bottom:2px}
.profile-handle{font-size:14px;color:var(--muted);margin-bottom:6px}
.profile-bio{font-size:14px;color:rgba(255,255,255,.7);line-height:1.55;margin-bottom:12px}
.profile-stats-row{display:flex;gap:28px;margin-bottom:16px}
.pstat{cursor:default}.pnum{font-size:18px;font-weight:700;display:block}.plbl{font-size:12px;color:var(--muted)}
.profile-hobby-tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px}
.ptag{padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;color:#fff}
.profile-action-btns{display:flex;gap:8px;margin-bottom:20px}
.prof-btn{padding:9px 20px;border-radius:12px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.07);color:var(--text);font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:background .2s}
.prof-btn:hover{background:rgba(255,255,255,0.12)}
.prof-btn.primary{background:linear-gradient(135deg,#FF6B6B,#FF8C42);border-color:transparent;color:#fff;box-shadow:0 3px 12px rgba(255,107,107,0.3)}
.profile-divider{height:1px;background:var(--border)}
.settings-wrap{max-width:640px;padding:24px}
.settings-sec-title{font-size:11px;font-weight:600;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin:20px 0 10px}
.setting-row{display:flex;align-items:center;gap:14px;padding:14px 16px;cursor:pointer;transition:background .15s;border-radius:12px}
.setting-row:hover{background:rgba(255,255,255,0.05)}
.setting-icon{font-size:20px;width:38px;height:38px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.07);border-radius:10px;flex-shrink:0}
.setting-label{font-size:14px;font-weight:500;flex:1}.setting-sub{font-size:12px;color:var(--muted);margin-top:1px}
.setting-chevron{color:var(--muted);font-size:18px}
.toggle{width:44px;height:24px;background:var(--surface2);border-radius:12px;position:relative;cursor:pointer;transition:background .25s;flex-shrink:0;border:none}
.toggle.on{background:var(--accent)}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:left .25s}
.toggle.on::after{left:23px}
.setting-divider{height:1px;background:var(--border);margin:8px 0}
.danger-btn{padding:11px 20px;border-radius:12px;border:1px solid rgba(239,68,68,0.3);background:rgba(239,68,68,0.08);color:#ef4444;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;margin-right:10px;margin-bottom:10px}
.danger-btn:hover{background:rgba(239,68,68,0.16)}
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,0);z-index:300;display:flex;align-items:center;justify-content:center;pointer-events:none;transition:background .25s}
#lightbox.open{background:rgba(0,0,0,0.88);pointer-events:all;backdrop-filter:blur(8px)}
.lb-wrap{display:flex;width:90%;max-width:900px;height:90vh;border-radius:20px;overflow:hidden;transform:scale(0.88) translateY(20px);opacity:0;transition:transform .3s cubic-bezier(.34,1.5,.64,1),opacity .22s;background:var(--surface);border:1px solid rgba(255,255,255,0.09)}
#lightbox.open .lb-wrap{transform:scale(1) translateY(0);opacity:1}
.lb-img-pane{flex:1;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center;min-width:0}
.lb-img-pane img{width:100%;height:100%;object-fit:contain}
.lb-detail{width:320px;flex-shrink:0;display:flex;flex-direction:column;border-left:1px solid var(--border)}
.lb-hdr{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
.lb-ava{border-radius:50%;width:36px;height:36px;object-fit:cover;border:2px solid var(--accent)}
.lb-user{font-weight:600;font-size:14px}.lb-time{font-size:12px;color:var(--muted)}
.lb-x{margin-left:auto;background:rgba(255,255,255,0.08);border:none;border-radius:50%;width:30px;height:30px;color:#fff;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s;flex-shrink:0}
.lb-x:hover{background:rgba(255,255,255,0.18)}
.lb-scroll{flex:1;overflow-y:auto}
.lb-tags{display:flex;flex-wrap:wrap;gap:6px;padding:12px 16px 4px}
.lb-tag{padding:4px 11px;border-radius:12px;font-size:11px;font-weight:600;color:#fff;cursor:pointer;transition:transform .15s}
.lb-tag:hover{transform:scale(1.07)}
.lb-actions{padding:10px 16px 4px;display:flex;gap:14px;align-items:center}
.lb-btn{background:none;border:none;cursor:pointer;font-size:22px;line-height:1;transition:transform .15s;padding:0}
.lb-btn:active{transform:scale(1.35)}
.lb-likes{padding:2px 16px 6px;font-size:13px;font-weight:600}
.lb-caption{padding:0 16px 6px;font-size:13px;line-height:1.65}
.lb-caption strong{font-weight:600;margin-right:5px}
.lb-viewcmt{font-size:12px;color:var(--muted);padding:0 16px 10px;cursor:pointer}.lb-viewcmt:hover{color:var(--text)}
.lb-comments-section{padding:0 16px 8px}
.lb-comment{display:flex;gap:10px;margin-bottom:12px;align-items:flex-start}
.lb-cmt-ava{width:26px;height:26px;border-radius:50%;object-fit:cover;flex-shrink:0}
.lb-cmt-body{background:var(--surface2);border-radius:10px;padding:8px 10px;font-size:12px;line-height:1.5;flex:1}
.lb-cmt-user{font-weight:600;margin-right:5px}
.lb-add-comment{display:flex;gap:8px;padding:0 16px 10px;align-items:center;flex-shrink:0}
.lb-cmt-input{flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:var(--text);outline:none;border-radius:20px;padding:8px 14px;font-size:12px;font-family:inherit;transition:border-color .2s}
.lb-cmt-input:focus{border-color:rgba(255,107,107,0.5)}
.lb-cmt-send{background:var(--accent);border:none;border-radius:50%;width:30px;height:30px;color:#fff;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:transform .15s}
.lb-cmt-send:hover{transform:scale(1.1)}
.lb-owner-delete{display:flex;padding:4px 16px 14px;border-top:1px solid var(--border)}
.lb-menu-row{display:flex;gap:6px;padding:4px 16px 14px;flex-wrap:wrap;flex-shrink:0;border-top:1px solid var(--border)}
.lb-menu-btn{padding:6px 12px;border-radius:18px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:var(--text);font-size:12px;cursor:pointer;font-family:inherit;transition:all .2s}
.lb-menu-btn:hover{background:rgba(255,255,255,0.1)}
.lb-menu-btn.danger{border-color:rgba(239,68,68,0.3);color:#ef4444}
.lb-menu-btn.danger:hover{background:rgba(239,68,68,0.1)}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0);z-index:400;display:flex;align-items:center;justify-content:center;pointer-events:none;transition:background .25s}
.modal-bg.open{background:rgba(0,0,0,0.75);pointer-events:all;backdrop-filter:blur(6px)}
.modal{background:var(--surface);border-radius:20px;padding:28px;width:90%;max-width:480px;border:1px solid rgba(255,255,255,0.1);transform:scale(0.9) translateY(20px);opacity:0;transition:transform .3s cubic-bezier(.34,1.5,.64,1),opacity .22s;max-height:88vh;overflow-y:auto}
.modal-bg.open .modal{transform:scale(1) translateY(0);opacity:1}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-title{font-weight:700;font-size:18px}
.modal-x{background:rgba(255,255,255,0.08);border:none;border-radius:50%;width:32px;height:32px;color:#fff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s}
.modal-x:hover{background:rgba(255,255,255,0.16)}
.img-picker{width:100%;aspect-ratio:1/1;border-radius:14px;border:2px dashed rgba(255,107,107,0.3);background:rgba(255,107,107,0.04);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;margin-bottom:16px;transition:border-color .2s;max-height:280px;position:relative}
.img-picker:hover{border-color:rgba(255,107,107,0.6)}
.img-picker img{width:100%;height:100%;object-fit:cover;display:block}
.picker-hint{text-align:center;color:var(--muted);pointer-events:none}
.picker-hint .big{font-size:36px;margin-bottom:8px}.picker-hint p{font-size:13px}
textarea.cap{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:var(--text);outline:none;border-radius:11px;padding:11px 12px;width:100%;font-size:14px;font-family:inherit;resize:none;margin-bottom:16px;transition:border-color .2s}
textarea.cap::placeholder{color:var(--muted)}
textarea.cap:focus{border-color:rgba(255,107,107,0.45)}
.tag-lbl{font-size:12px;color:var(--muted);margin-bottom:10px;font-weight:500}
.tag-grid{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:20px}
.tpick{padding:6px 13px;border-radius:16px;font-size:12px;cursor:pointer;font-weight:500;transition:all .15s;font-family:inherit}
.btn-primary{width:100%;padding:13px;border-radius:13px;border:none;background:linear-gradient(135deg,#FF6B6B,#FF8C42);color:#fff;font-weight:700;font-size:15px;cursor:pointer;font-family:inherit;box-shadow:0 4px 18px rgba(255,107,107,0.35);transition:transform .2s;display:flex;align-items:center;justify-content:center;gap:6px}
.btn-primary:hover:not(:disabled){transform:translateY(-2px)}
.btn-primary:disabled{background:rgba(255,255,255,0.09);color:var(--muted);cursor:not-allowed;box-shadow:none;transform:none}
.progress-wrap{width:100%;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;margin-bottom:12px;display:none}
.progress-bar{height:100%;background:linear-gradient(135deg,#FF6B6B,#FF8C42);width:0%;transition:width .3s;border-radius:3px}
.report-option{display:flex;align-items:center;gap:14px;padding:14px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:opacity .15s}
.report-option:last-child{border-bottom:none}.report-option:hover{opacity:.75}
.report-icon{font-size:22px;width:36px;text-align:center;flex-shrink:0}
.action-btn{width:100%;padding:13px;border-radius:12px;border:none;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;margin-bottom:10px;transition:all .2s}
.action-btn.danger{background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.2)}
.action-btn.danger:hover{background:rgba(239,68,68,0.18)}
.action-btn.ghost{background:rgba(255,255,255,0.07);color:var(--text)}.action-btn.ghost:hover{background:rgba(255,255,255,0.12)}
.finput{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:var(--text);outline:none;border-radius:11px;padding:11px 12px;width:100%;font-size:14px;font-family:inherit;margin-bottom:14px;transition:border-color .2s}
.finput:focus{border-color:rgba(255,107,107,0.45)}
@media(max-width:900px){
  #sidebar,#right{display:none}#center{border-right:none}#layout{display:block;max-width:100%}
  #mobileNav{display:flex!important}
  .hobby-cards{grid-template-columns:repeat(2,1fr)}.trend-grid-4{grid-template-columns:repeat(2,1fr)}.explore-grid{grid-template-columns:1fr}
  .lb-wrap{flex-direction:column;width:96%;height:95vh}.lb-img-pane{flex:none;height:55%}.lb-detail{width:100%;border-left:none;border-top:1px solid var(--border);flex:1}
  .profile-cover{height:120px}.screen{padding-bottom:70px}
}
@media(min-width:901px){#mobileNav{display:none!important}}
#mobileNav{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,15,0.97);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,0.07);justify-content:space-around;padding:7px 0 12px;z-index:100}
.mob-btn{background:none;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:2px;color:var(--muted);font-family:inherit;transition:color .2s;padding:0 8px}
.mob-btn.active{color:var(--accent)}.mob-icon{font-size:19px}.mob-lbl{font-size:10px}.mob-btn.active .mob-lbl{font-weight:600}
#toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--surface);border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:11px 20px;font-size:13px;font-weight:500;z-index:9999;opacity:0;transition:opacity .3s,transform .3s;pointer-events:none;white-space:nowrap;box-shadow:0 8px 24px rgba(0,0,0,.4)}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>

<!-- AUTH WALL -->
<div id="authWall">
  <div class="auth-split">
    <div class="auth-brand">
      <div class="auth-brand-logo">hobbifinder</div>
      <div class="auth-brand-tag">Share your passions.<br>Connect with your people.</div>
      <div class="auth-preview">
        <img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=200&q=70" alt="">
        <img src="https://images.unsplash.com/photo-1513364776144-60967b0f800f?w=200&q=70" alt="">
        <img src="https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=200&q=70" alt="">
        <img src="https://images.unsplash.com/photo-1502680390469-be75c86b636f?w=200&q=70" alt="">
      </div>
    </div>
    <div class="auth-form-side">
      <div class="auth-title" id="authTitle">Welcome back</div>
      <div class="auth-sub" id="authSub">Sign in to your account</div>
      <div class="auth-tabs">
        <button class="auth-tab active" id="tabLogin">Log In</button>
        <button class="auth-tab" id="tabSignup">Sign Up</button>
      </div>
      <div class="auth-error" id="authError"></div>
      <!-- LOGIN -->
      <div id="loginForm">
        <div class="auth-field"><label>Email</label><input class="auth-input" id="loginEmail" type="email" placeholder="you@email.com" autocomplete="email"></div>
        <div class="auth-field"><label>Password</label><input class="auth-input" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
        <button class="auth-submit" id="loginBtn">Log In</button>
      </div>
      <!-- SIGNUP -->
      <div id="signupForm" style="display:none">
        <div class="auth-field"><label>Full Name</label><input class="auth-input" id="suName" placeholder="Jane Smith"></div>
        <div class="auth-field"><label>Username</label><input class="auth-input" id="suUser" placeholder="jane_hobbies"></div>
        <div class="auth-field"><label>Email</label><input class="auth-input" id="suEmail" type="email" placeholder="you@email.com"></div>
        <div class="auth-field"><label>Password</label><input class="auth-input" id="suPass" type="password" placeholder="Min. 6 characters"></div>
        <div class="auth-field"><label>Your Hobbies (optional)</label><div class="auth-hobby-row" id="signupHobbyPicker"></div></div>
        <button class="auth-submit" id="signupBtn">Create Account</button>
      </div>
      <div class="auth-fine">By continuing you agree to our Terms of Service. Harmful content is prohibited.</div>
    </div>
  </div>
</div>

<!-- APP SHELL -->
<div id="appShell">
<div id="layout">
  <aside id="sidebar">
    <div class="sidebar-logo">hobbifinder</div>
    <button class="nav-item active" id="nav-home"><span class="ni-icon">üè†</span><span>Home</span></button>
    <button class="nav-item" id="nav-explore"><span class="ni-icon">üîç</span><span>Explore</span></button>
    <button class="nav-item" id="nav-hobbies"><span class="ni-icon">üéØ</span><span>Hobbies</span></button>
    <button class="nav-item" id="nav-profile"><span class="ni-icon">üë§</span><span>Profile</span></button>
    <button class="nav-item" id="nav-settings"><span class="ni-icon">‚öôÔ∏è</span><span>Settings</span></button>
    <div class="sidebar-divider"></div>
    <button class="sidebar-post-btn" id="sidebarPostBtn">+ New Post</button>
    <div class="sidebar-spacer"></div>
    <div class="sidebar-user" id="sidebarUserCard">
      <img id="sidebarAva" src="" alt="">
      <div><div class="sidebar-user-name" id="sidebarName">@you</div><div class="sidebar-user-sub">View profile</div></div>
    </div>
  </aside>

  <main id="center">
    <div class="center-header">
      <div class="center-title" id="centerTitle">Home</div>
      <input class="center-search" id="searchInput" placeholder="Search posts, users, hobbies...">
    </div>
    <div class="chips-bar" id="chipsBar"></div>

    <!-- HOME -->
    <div id="screen-home" class="screen active">
      <div class="grid-wrap">
        <div class="loading-grid" id="loadingGrid"><div style="font-size:36px;margin-bottom:12px">‚è≥</div><p>Loading posts...</p></div>
        <div class="photo-grid" id="photoGrid"></div>
        <div id="emptyState" class="empty-state hidden"><div class="big">üì∏</div><p>No posts yet ‚Äî be the first to share!</p></div>
      </div>
    </div>

    <!-- EXPLORE -->
    <div id="screen-explore" class="screen">
      <div class="sec-title">Browse by Hobby</div>
      <div class="explore-grid" id="exploreTags"></div>
      <div class="sec-title">Trending Now</div>
      <div class="trend-grid-4" id="trendGrid"></div>
    </div>

    <!-- HOBBIES -->
    <div id="screen-hobbies" class="screen">
      <div class="sec-title">All Hobbies</div>
      <div class="hobby-cards" id="hobbyCards"></div>
    </div>

    <!-- PROFILE -->
    <div id="screen-profile" class="screen" style="padding-bottom:0">
      <div class="profile-cover"></div>
      <div class="profile-info">
        <div class="profile-pic-wrap">
          <img class="profile-pic" id="profilePic" src="" alt="">
          <input type="file" id="avatarInput" accept="image/*" style="display:none">
        </div>
        <div class="profile-name" id="profileName">@you</div>
        <div class="profile-handle" id="profileHandle">Hobby Enthusiast</div>
        <div class="profile-bio" id="profileBio">Welcome to hobbifinder!</div>
        <div class="profile-stats-row">
          <div class="pstat"><span class="pnum" id="profilePostCount">0</span><span class="plbl">Posts</span></div>
        </div>
        <div class="profile-hobby-tags" id="profileTags"></div>
        <div class="profile-action-btns">
          <button class="prof-btn primary" id="editProfileBtn">Edit Profile</button>
          <button class="prof-btn" id="changePhotoBtn">üì∑ Change Photo</button>
        </div>
      </div>
      <div class="profile-divider"></div>
      <div class="grid-wrap" style="padding-top:4px;padding-bottom:20px">
        <div class="photo-grid" id="profileGrid"></div>
        <div id="profileEmpty" class="empty-state hidden"><div class="big">üì∑</div><p>No posts yet. Share your first!</p></div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="screen-settings" class="screen">
      <div class="settings-wrap">
        <div style="font-size:20px;font-weight:700;margin-bottom:4px">Settings</div>
        <div class="settings-sec-title">Privacy</div>
        <div class="setting-row" id="toggle-row-privateAccount"><div class="setting-icon">üîí</div><div style="flex:1"><div class="setting-label">Private Account</div><div class="setting-sub">Only followers see your posts</div></div><button class="toggle" id="toggle-privateAccount"></button></div>
        <div class="setting-row" id="toggle-row-contentFilter"><div class="setting-icon">üõ°Ô∏è</div><div style="flex:1"><div class="setting-label">Content Filter</div></div><button class="toggle on" id="toggle-contentFilter"></button></div>
        <div class="setting-divider"></div>
        <div class="settings-sec-title">Account</div>
        <div style="padding:12px 0">
          <button class="danger-btn" id="logoutBtn">Log Out</button>
          <button class="danger-btn" id="deleteAccBtn">Delete Account</button>
        </div>
        <div style="font-size:11px;color:rgba(255,255,255,.15);line-height:1.7">hobbifinder ¬∑ CSAM reported to NCMEC immediately.</div>
      </div>
    </div>
  </main>

  <aside id="right">
    <div style="margin-bottom:16px"><div class="ad-box ad-rect"><span class="ad-lbl">Advertisement</span><span class="ad-dim">300√ó250</span></div></div>
    <div class="widget"><div class="widget-title">Trending Hobbies</div><div id="trendingHobbies"></div></div>
    <div class="widget" style="margin-bottom:0"><div class="ad-box ad-sq"><span class="ad-lbl">Sponsored</span><span class="ad-dim">300√ó200</span></div></div>
  </aside>
</div>

<nav id="mobileNav" style="display:none">
  <button class="mob-btn active" id="mob-home"><span class="mob-icon">üè†</span><span class="mob-lbl">Home</span></button>
  <button class="mob-btn" id="mob-explore"><span class="mob-icon">üîç</span><span class="mob-lbl">Explore</span></button>
  <button class="mob-btn" id="mob-hobbies"><span class="mob-icon">üéØ</span><span class="mob-lbl">Hobbies</span></button>
  <button class="mob-btn" id="mob-profile"><span class="mob-icon">üë§</span><span class="mob-lbl">Profile</span></button>
</nav>
</div><!-- /appShell -->

<!-- LIGHTBOX -->
<div id="lightbox">
  <div class="lb-wrap">
    <div class="lb-img-pane"><img id="lbImg" src="" alt=""></div>
    <div class="lb-detail">
      <div class="lb-hdr">
        <img class="lb-ava" id="lbAva" src="" alt="">
        <div><div class="lb-user" id="lbUser"></div><div class="lb-time" id="lbTime"></div></div>
        <button class="lb-x" id="lbClose">‚úï</button>
      </div>
      <div class="lb-scroll">
        <div class="lb-tags" id="lbTags"></div>
        <div class="lb-actions">
          <button class="lb-btn" id="lbLike">ü§ç</button>
          <button class="lb-btn" id="lbCmtBtn">üí¨</button>
          <button class="lb-btn" id="lbShare">üîó</button>
          <div style="flex:1"></div>
          <button class="lb-btn" id="lbSave">üîñ</button>
        </div>
        <div class="lb-likes" id="lbLikes"></div>
        <div class="lb-caption" id="lbCaption"></div>
        <div class="lb-viewcmt" id="lbViewCmt"></div>
        <div class="lb-comments-section" id="lbCmtSection"></div>
      </div>
      <div class="lb-add-comment">
        <img id="lbMyAva" src="" style="width:26px;height:26px;border-radius:50%;object-fit:cover;flex-shrink:0" alt="">
        <input class="lb-cmt-input" id="lbCmtInput" placeholder="Add a comment...">
        <button class="lb-cmt-send" id="lbCmtSend">‚û§</button>
      </div>
      <div class="lb-menu-row" id="lbMenuRow"></div>
    </div>
  </div>
</div>

<!-- UPLOAD MODAL -->
<div class="modal-bg" id="uploadModal">
  <div class="modal">
    <div class="modal-head"><span class="modal-title">üì∏ New Post</span><button class="modal-x" id="uploadClose">‚úï</button></div>
    <div class="img-picker" id="imgPicker">
      <div class="picker-hint" id="pickerHint"><div class="big">üñºÔ∏è</div><p>Click to choose a photo</p></div>
      <img id="previewImg" style="display:none" alt="">
    </div>
    <input type="file" id="fileInput" accept="image/*" style="display:none">
    <div class="progress-wrap" id="progressWrap"><div class="progress-bar" id="progressBar"></div></div>
    <textarea class="cap" id="captionInput" rows="3" placeholder="Write a caption..."></textarea>
    <div class="tag-lbl">Tag your hobbies</div>
    <div class="tag-grid" id="tagGrid"></div>
    <button class="btn-primary" id="btnShare" disabled>Share Post</button>
  </div>
</div>

<!-- REPORT MODAL -->
<div class="modal-bg" id="reportModal">
  <div class="modal">
    <div class="modal-head"><span class="modal-title">üö© Report</span><button class="modal-x" id="reportClose">‚úï</button></div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px">Anonymous. Reviewed within 24 hours.</p>
    <div id="reportOptions"></div>
  </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div class="modal-bg" id="editProfileModal">
  <div class="modal">
    <div class="modal-head"><span class="modal-title">Edit Profile</span><button class="modal-x" id="editProfileClose">‚úï</button></div>
    <div class="tag-lbl">Display Name</div><input class="finput" id="editName">
    <div class="tag-lbl">Bio</div><textarea class="cap" id="editBio" rows="3"></textarea>
    <div class="tag-lbl">My Hobbies</div><div class="tag-grid" id="editTagGrid"></div>
    <button class="btn-primary" id="saveProfileBtn">Save Changes</button>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-bg" id="confirmModal">
  <div class="modal">
    <div class="modal-head"><span class="modal-title" id="confirmTitle"></span><button class="modal-x" id="confirmClose">‚úï</button></div>
    <p style="font-size:14px;line-height:1.7;margin-bottom:20px;color:rgba(255,255,255,.8)" id="confirmMsg"></p>
    <button class="action-btn danger" id="confirmOkBtn"></button>
    <button class="action-btn ghost" id="confirmCancelBtn">Cancel</button>
  </div>
</div>

<div id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FIREBASE (module)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script type="module">
import { initializeApp }             from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
         signOut, onAuthStateChanged, updateProfile, deleteUser }
                                      from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, updateDoc, setDoc, getDoc,
         deleteDoc, query, orderBy, onSnapshot, serverTimestamp,
         arrayUnion, arrayRemove }    from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
import { getStorage, ref as sRef,
         uploadBytesResumable, getDownloadURL }
                                      from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const app = initializeApp({
  apiKey:            "AIzaSyC_7Urz9nNpFBOhMXQSRC-GQi7_YMVQIzY",
  authDomain:        "hobbifinder-d9240.firebaseapp.com",
  projectId:         "hobbifinder-d9240",
  storageBucket:     "hobbifinder-d9240.firebasestorage.app",
  messagingSenderId: "360754218729",
  appId:             "1:360754218729:web:d9c867e404fc0735cf9278"
});
const auth    = getAuth(app);
const db      = getFirestore(app);
const storage = getStorage(app);

// ‚îÄ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HOBBIES = ["Photography","Painting","Cooking","Gaming","Hiking","Gardening","Music","Reading","Fitness","Travel","Knitting","Cycling","Surfing","Drawing","Yoga","DIY","Film","Dance","Pottery","Coding"];
const HOBBY_ICONS = {Photography:"üì∑",Painting:"üé®",Cooking:"üç≥",Gaming:"üéÆ",Hiking:"ü•æ",Gardening:"üå±",Music:"üé∏",Reading:"üìö",Fitness:"üí™",Travel:"‚úàÔ∏è",Knitting:"üß∂",Cycling:"üö¥",Surfing:"üèÑ",Drawing:"‚úèÔ∏è",Yoga:"üßò",DIY:"üî®",Film:"üé¨",Dance:"üíÉ",Pottery:"üè∫",Coding:"üíª"};
const TAG_COLORS = {Photography:"#FF6B6B",Painting:"#4ECDC4",Cooking:"#FFE66D",Gaming:"#A78BFA",Hiking:"#6EE7B7",Gardening:"#86EFAC",Music:"#FCA5A5",Reading:"#93C5FD",Fitness:"#FB923C",Travel:"#67E8F9",Knitting:"#F9A8D4",Cycling:"#A3E635",Surfing:"#38BDF8",Drawing:"#FBBF24",Yoga:"#C4B5FD",DIY:"#D97706",Film:"#9CA3AF",Dance:"#EC4899",Pottery:"#B45309",Coding:"#10B981"};
const REPORT_REASONS = [
  {icon:"üîû",label:"Nudity / Sexual Content"},
  {icon:"üë∂",label:"Child Safety",ncmec:true},
  {icon:"üí∞",label:"Spam or Scam"},
  {icon:"üò°",label:"Hate Speech / Harassment"},
  {icon:"‚ö†Ô∏è",label:"Violence"},
  {icon:"¬©Ô∏è",label:"Copyright Violation"},
  {icon:"üî´",label:"Illegal Activity"},
  {icon:"üÜò",label:"Self-Harm"}
];

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUser    = null;
let currentProfile = null;
let allPosts       = [];
let selectedHobby  = null;
let searchTerm     = "";
let activeLbId     = null;
let newPostTags    = [];
let newPostFile    = null;
let signupHobbies  = [];
let unsubPosts     = null;
let settings       = {privateAccount:false, contentFilter:true};

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const $  = id => document.getElementById(id);
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const fmt = n => n >= 1000 ? (n/1000).toFixed(1)+'k' : n;

let toastTimer;
function toast(msg) {
  const t = $('toast'); t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer); toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

function openModal(id)  { $(id).classList.add('open');    }
function closeModal(id) { $(id).classList.remove('open'); }

// ‚îÄ‚îÄ‚îÄ AUTH STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onAuthStateChanged(auth, async user => {
  if (user) {
    currentUser = user;
    const snap = await getDoc(doc(db,'users',user.uid));
    if (snap.exists()) {
      currentProfile = snap.data();
    } else {
      currentProfile = {
        uid: user.uid,
        username: user.displayName || 'user_' + user.uid.slice(0,6),
        name: user.displayName || 'New User',
        bio: '', hobbies: [],
        avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName||'User')}&background=FF6B6B&color=fff&size=80`
      };
    }
    $('authWall').style.display  = 'none';
    $('appShell').style.display  = 'block';
    initApp();
  } else {
    currentUser = currentProfile = null;
    $('appShell').style.display  = 'none';
    $('authWall').style.display  = 'flex';
    if (unsubPosts) { unsubPosts(); unsubPosts = null; }
  }
});

// ‚îÄ‚îÄ‚îÄ AUTH UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('tabLogin').onclick  = () => switchAuthTab('login');
$('tabSignup').onclick = () => switchAuthTab('signup');

function switchAuthTab(tab) {
  $('tabLogin').classList.toggle('active',  tab === 'login');
  $('tabSignup').classList.toggle('active', tab === 'signup');
  $('loginForm').style.display   = tab === 'login'  ? 'block' : 'none';
  $('signupForm').style.display  = tab === 'signup' ? 'block' : 'none';
  $('authTitle').textContent     = tab === 'login'  ? 'Welcome back'    : 'Create account';
  $('authSub').textContent       = tab === 'login'  ? 'Sign in to your account' : 'Join hobbifinder';
  $('authError').style.display   = 'none';
  if (tab === 'signup') buildSignupHobbyPicker();
}

function showAuthError(msg) { const e = $('authError'); e.textContent = msg; e.style.display = 'block'; }

function buildSignupHobbyPicker() {
  const el = $('signupHobbyPicker'); el.innerHTML = '';
  HOBBIES.slice(0,12).forEach(h => {
    const c = TAG_COLORS[h], sel = signupHobbies.includes(h);
    const b = document.createElement('button'); b.className = 'auth-hobby-chip'; b.textContent = h;
    b.style.cssText = sel ? `background:${c};border-color:${c};color:#fff` : `background:${c}18;border-color:${c}55;color:${c}`;
    b.onclick = () => { signupHobbies.includes(h) ? (signupHobbies = signupHobbies.filter(x=>x!==h)) : signupHobbies.push(h); buildSignupHobbyPicker(); };
    el.appendChild(b);
  });
}

// LOGIN
$('loginBtn').onclick = async () => {
  const email = $('loginEmail').value.trim();
  const pass  = $('loginPass').value;
  if (!email || !pass) { showAuthError('Please fill in all fields.'); return; }
  const btn = $('loginBtn');
  btn.disabled = true; btn.innerHTML = '<span class="spin"></span>Signing in...';
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(e) {
    const m = { 'auth/user-not-found':'No account found with that email.','auth/invalid-credential':'Incorrect email or password.','auth/wrong-password':'Incorrect password.','auth/invalid-email':'Invalid email address.','auth/too-many-requests':'Too many attempts ‚Äî try again later.' };
    showAuthError(m[e.code] || ('Error: ' + e.message));
  }
  btn.disabled = false; btn.innerHTML = 'Log In';
};
$('loginPass').onkeydown = e => { if (e.key === 'Enter') $('loginBtn').click(); };

// SIGNUP
$('signupBtn').onclick = async () => {
  const name     = $('suName').value.trim();
  const username = $('suUser').value.trim().toLowerCase().replace(/\s+/g,'_');
  const email    = $('suEmail').value.trim();
  const pass     = $('suPass').value;
  if (!name||!username||!email||!pass) { showAuthError('Please fill in all fields.'); return; }
  if (username.length < 3)             { showAuthError('Username must be at least 3 characters.'); return; }
  if (pass.length < 6)                 { showAuthError('Password must be at least 6 characters.'); return; }
  if (!/^[a-z0-9_.]+$/.test(username)) { showAuthError('Username: letters, numbers, . and _ only.'); return; }
  const btn = $('signupBtn');
  btn.disabled = true; btn.innerHTML = '<span class="spin"></span>Creating account...';
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    const avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=FF6B6B&color=fff&size=80`;
    await updateProfile(cred.user, { displayName: username, photoURL: avatar });
    await setDoc(doc(db,'users',cred.user.uid), {
      uid: cred.user.uid, username, name, bio: '', email,
      hobbies: signupHobbies.slice(0,5), avatar,
      createdAt: serverTimestamp()
    });
    toast(`Welcome to hobbifinder, ${name}! üéâ`);
  } catch(e) {
    const m = {'auth/email-already-in-use':'An account with this email already exists.','auth/invalid-email':'Invalid email.','auth/weak-password':'Password must be at least 6 characters.'};
    showAuthError(m[e.code] || ('Error: ' + e.message));
  }
  btn.disabled = false; btn.innerHTML = 'Create Account';
};
$('suPass').onkeydown = e => { if (e.key === 'Enter') $('signupBtn').click(); };

// ‚îÄ‚îÄ‚îÄ INIT APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initApp() {
  $('sidebarAva').src         = currentProfile.avatar;
  $('sidebarName').textContent = '@' + currentProfile.username;
  $('lbMyAva').src            = currentProfile.avatar;
  buildChips(); buildExplore(); buildHobbyCards(); buildRightSidebar();
  switchTab('home');
  renderProfilePage();
  subscribeFeed();
}

// ‚îÄ‚îÄ‚îÄ REAL-TIME FEED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function subscribeFeed() {
  $('loadingGrid').style.display = 'block';
  $('photoGrid').innerHTML = '';
  $('emptyState').classList.add('hidden');
  if (unsubPosts) unsubPosts();
  const q = query(collection(db,'posts'), orderBy('createdAt','desc'));
  unsubPosts = onSnapshot(q, snap => {
    allPosts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    $('loadingGrid').style.display = 'none';
    renderGrid(); buildExplore(); buildHobbyCards(); buildRightSidebar();
    if (activeLbId) refreshLb();
  }, err => {
    $('loadingGrid').style.display = 'none';
    toast('Could not load posts. Check Firestore rules.');
    console.error(err);
  });
}

// ‚îÄ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TABS = ['home','explore','hobbies','profile','settings'];
const TITLES = {home:'Home',explore:'Explore',hobbies:'Hobbies',profile:'Profile',settings:'Settings'};

function switchTab(tab) {
  TABS.forEach(t => {
    const s = $('screen-'+t); if (s) s.classList.toggle('active', t===tab);
    const n = $('nav-'+t);    if (n) n.classList.toggle('active', t===tab);
    const m = $('mob-'+t);    if (m) m.classList.toggle('active', t===tab);
  });
  $('chipsBar').style.display   = tab==='home' ? '' : 'none';
  $('searchInput').style.display= tab==='home' ? '' : 'none';
  $('centerTitle').textContent  = TITLES[tab] || tab;
  if (tab==='profile') renderProfilePage();
}

// Wire nav buttons
TABS.forEach(t => {
  const n = $('nav-'+t); if (n) n.onclick = () => switchTab(t);
  const m = $('mob-'+t); if (m) m.onclick = () => switchTab(t);
});
$('sidebarUserCard').onclick = () => switchTab('profile');
$('sidebarPostBtn').onclick  = () => openUploadModal();

// ‚îÄ‚îÄ‚îÄ CHIPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildChips() {
  const w = $('chipsBar'); w.innerHTML = '';
  const all = document.createElement('button');
  all.className = 'chip all' + (selectedHobby===null?' active':''); all.textContent = 'All';
  all.onclick = () => { selectedHobby=null; buildChips(); renderGrid(); }; w.appendChild(all);
  HOBBIES.forEach(h => {
    const c=TAG_COLORS[h], b=document.createElement('button'); b.className='chip'; b.textContent=h;
    b.style.cssText = selectedHobby===h ? `background:${c};border-color:${c};color:#fff` : `background:${c}18;border-color:${c}44;color:${c}`;
    b.onclick = () => { selectedHobby = selectedHobby===h ? null : h; buildChips(); renderGrid(); };
    w.appendChild(b);
  });
}

// ‚îÄ‚îÄ‚îÄ GRID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getFiltered() {
  return allPosts.filter(p => {
    if (!p.imageUrl) return false;
    const hOk = !selectedHobby || (p.tags||[]).includes(selectedHobby);
    const st  = searchTerm.toLowerCase();
    const sOk = !st || (p.user||'').toLowerCase().includes(st) || (p.caption||'').toLowerCase().includes(st) || (p.tags||[]).some(t=>t.toLowerCase().includes(st));
    return hOk && sOk;
  });
}

function renderGrid() {
  const grid  = $('photoGrid'), empty = $('emptyState');
  const posts = getFiltered(); grid.innerHTML = '';
  if (!posts.length) { empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');
  posts.forEach((post, i) => {
    const cell = document.createElement('div'); cell.className = 'grid-cell';
    cell.style.animationDelay = `${(i%9)*.03}s`;
    const dot   = (post.tags&&post.tags[0]) ? TAG_COLORS[post.tags[0]] : '#FF6B6B';
    const likes = Array.isArray(post.likes) ? post.likes.length : 0;
    const cmts  = Array.isArray(post.comments) ? post.comments.length : 0;
    cell.innerHTML = `<img src="${post.imageUrl}" alt="" loading="lazy"><div class="grid-overlay"><span class="grid-stat">‚ù§Ô∏è ${fmt(likes)}</span><span class="grid-stat">üí¨ ${cmts}</span></div><div class="grid-dot" style="background:${dot}"></div>`;
    cell.onclick = () => openLb(post.id);
    grid.appendChild(cell);
  });
}

$('searchInput').oninput = function() { searchTerm = this.value; renderGrid(); };

// ‚îÄ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const lb = $('lightbox');

function openLb(id) {
  const post = allPosts.find(p=>p.id===id); if (!post) return;
  activeLbId = id;
  $('lbAva').src  = post.avatar || '';
  $('lbUser').textContent = '@' + (post.user||'unknown');
  $('lbTime').textContent = post.timeAgo || 'recently';
  $('lbImg').src  = post.imageUrl;
  refreshLbInteractive(post);
  $('lbCaption').innerHTML = `<strong>@${post.user}</strong> ${esc(post.caption||'')}`;
  $('lbTags').innerHTML = (post.tags||[]).map(t=>`<span class="lb-tag" style="background:${TAG_COLORS[t]||'#888'}cc" data-tag="${t}">#${t}</span>`).join('');
  $('lbTags').querySelectorAll('.lb-tag').forEach(el => el.onclick = () => { closeLb(); selectedHobby=el.dataset.tag; buildChips(); renderGrid(); });
  $('lbCmtSection').style.display='none'; $('lbCmtSection').innerHTML='';
  // Menu row
  const menu = $('lbMenuRow'); menu.innerHTML='';
  const isOwn = currentUser && post.uid === currentUser.uid;
  if (!isOwn) {
    const rpt = document.createElement('button'); rpt.className='lb-menu-btn danger'; rpt.textContent='üö© Report';
    rpt.onclick = () => { closeLb(); openReport(post.user); }; menu.appendChild(rpt);
  }
  if (isOwn) {
    const del = document.createElement('button'); del.className='lb-menu-btn danger'; del.textContent='üóëÔ∏è Delete Post';
    del.onclick = () => confirmDeletePost(post.id); menu.appendChild(del);
  }
  lb.classList.add('open'); document.body.style.overflow='hidden';
}

function refreshLb() {
  if (!activeLbId) return;
  const post = allPosts.find(p=>p.id===activeLbId); if (!post) return;
  refreshLbInteractive(post);
}

function refreshLbInteractive(post) {
  const likes = Array.isArray(post.likes) ? post.likes : [];
  const liked = currentUser && likes.includes(currentUser.uid);
  $('lbLike').textContent = liked ? '‚ù§Ô∏è' : 'ü§ç';
  $('lbLikes').textContent = likes.length.toLocaleString() + ' likes';
  const saved = Array.isArray(post.saved) && currentUser && post.saved.includes(currentUser.uid);
  $('lbSave').style.opacity = saved ? '1' : '0.5';
  const cmts = Array.isArray(post.comments) ? post.comments : [];
  const vc = $('lbViewCmt'); vc.textContent = cmts.length ? `View all ${cmts.length} comments` : ''; vc.onclick = () => toggleCmts(post.id);
}

function closeLb() { lb.classList.remove('open'); document.body.style.overflow=''; activeLbId=null; }
$('lbClose').onclick = closeLb;
lb.addEventListener('click', e => { if (e.target===lb) closeLb(); });
document.addEventListener('keydown', e => { if (e.key==='Escape' && lb.classList.contains('open')) closeLb(); });

function toggleCmts(id) {
  const post = allPosts.find(p=>p.id===id); const cs = $('lbCmtSection');
  if (cs.style.display==='block') { cs.style.display='none'; return; }
  const cmts = Array.isArray(post.comments) ? post.comments : [];
  cs.innerHTML = cmts.length
    ? cmts.map(c=>`<div class="lb-comment"><img class="lb-cmt-ava" src="${c.a||''}" alt="" onerror="this.style.display='none'"><div class="lb-cmt-body"><span class="lb-cmt-user">@${esc(c.u)}</span>${esc(c.t)}<div style="font-size:10px;color:var(--muted);margin-top:3px">${c.time}</div></div></div>`).join('')
    : '<p style="font-size:13px;color:var(--muted);padding-bottom:12px">No comments yet. Be first!</p>';
  cs.style.display='block';
}

// Like
$('lbLike').onclick = async function() {
  if (!activeLbId||!currentUser) return;
  const post  = allPosts.find(p=>p.id===activeLbId); if (!post) return;
  const likes = Array.isArray(post.likes) ? post.likes : [];
  const liked = likes.includes(currentUser.uid);
  try {
    await updateDoc(doc(db,'posts',activeLbId), { likes: liked ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid) });
    if (!liked) { this.style.animation='pulse .3s ease'; setTimeout(()=>this.style.animation='',300); }
  } catch(e) { toast('Could not update like'); }
};

// Save
$('lbSave').onclick = async function() {
  if (!activeLbId||!currentUser) return;
  const post  = allPosts.find(p=>p.id===activeLbId); if (!post) return;
  const saved = Array.isArray(post.saved) ? post.saved : [];
  const isSaved = saved.includes(currentUser.uid);
  try {
    await updateDoc(doc(db,'posts',activeLbId), { saved: isSaved ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid) });
    toast(isSaved ? 'Post unsaved' : 'Post saved! üîñ');
  } catch(e) { toast('Could not save post'); }
};

// Share
$('lbShare').onclick = () => {
  try { navigator.clipboard.writeText(window.location.href).then(()=>toast('Link copied! üîó')); } catch { toast('Link copied! üîó'); }
};

// Comment toggle
$('lbCmtBtn').onclick = () => { if (activeLbId) { toggleCmts(activeLbId); setTimeout(()=>$('lbCmtInput').focus(),100); } };

// Submit comment
$('lbCmtSend').onclick = submitCmt;
$('lbCmtInput').onkeydown = e => { if (e.key==='Enter') submitCmt(); };
async function submitCmt() {
  const inp = $('lbCmtInput'), text = inp.value.trim();
  if (!text||!activeLbId||!currentUser||!currentProfile) return;
  const cmt = { u: currentProfile.username, a: currentProfile.avatar, t: text, time: 'Just now' };
  try {
    const post = allPosts.find(p=>p.id===activeLbId);
    const cmts = Array.isArray(post.comments) ? [...post.comments] : [];
    cmts.push(cmt);
    await updateDoc(doc(db,'posts',activeLbId), { comments: cmts });
    inp.value = '';
    const cs = $('lbCmtSection');
    if (cs.style.display==='block') {
      const el = document.createElement('div'); el.className='lb-comment';
      el.innerHTML=`<img class="lb-cmt-ava" src="${currentProfile.avatar}" alt=""><div class="lb-cmt-body"><span class="lb-cmt-user">@${esc(currentProfile.username)}</span>${esc(text)}<div style="font-size:10px;color:var(--muted);margin-top:3px">Just now</div></div>`;
      cs.appendChild(el); cs.scrollTop=cs.scrollHeight;
    }
    toast('Comment posted! üí¨');
  } catch(e) { toast('Could not post comment'); }
}

// Delete post (owner only)
function confirmDeletePost(postId) {
  closeLb();
  $('confirmTitle').textContent = 'Delete Post';
  $('confirmMsg').textContent   = 'This will permanently delete your post. This cannot be undone.';
  $('confirmOkBtn').textContent = 'Delete Post';
  $('confirmOkBtn').onclick = async () => {
    closeModal('confirmModal');
    try { await deleteDoc(doc(db,'posts',postId)); toast('Post deleted'); }
    catch(e) { toast('Could not delete post'); }
  };
  openModal('confirmModal');
}

// ‚îÄ‚îÄ‚îÄ REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openReport(username) {
  $('reportOptions').innerHTML = '';
  REPORT_REASONS.forEach(r => {
    const div = document.createElement('div'); div.className='report-option';
    div.innerHTML = `<div class="report-icon">${r.icon}</div><div><div style="font-size:14px;font-weight:500">${r.label}</div></div>`;
    div.onclick = () => { closeModal('reportModal'); toast(r.ncmec ? 'üö® Reported to NCMEC. Thank you.' : '‚úÖ Report submitted ‚Äî reviewed within 24h'); };
    $('reportOptions').appendChild(div);
  });
  openModal('reportModal');
}
$('reportClose').onclick = () => closeModal('reportModal');

// ‚îÄ‚îÄ‚îÄ EXPLORE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildExplore() {
  const et = $('exploreTags'); et.innerHTML = '';
  HOBBIES.forEach(h => {
    const c = TAG_COLORS[h], cnt = allPosts.filter(p=>(p.tags||[]).includes(h)).length;
    const card = document.createElement('div'); card.className='etag-card'; card.style.cssText=`background:${c}18;border-color:${c}33;color:#fff`;
    card.innerHTML=`<div class="etag-icon">${HOBBY_ICONS[h]}</div><div><div class="etag-name" style="color:${c}">#${h}</div><div class="etag-count">${cnt} posts</div></div>`;
    card.onclick = () => { switchTab('home'); selectedHobby=h; buildChips(); renderGrid(); }; et.appendChild(card);
  });
  const tg = $('trendGrid'); tg.innerHTML = '';
  [...allPosts].sort((a,b)=>(b.likes?.length||0)-(a.likes?.length||0)).slice(0,8).forEach(post => {
    const cell = document.createElement('div'); cell.className='trend-cell';
    cell.innerHTML=`<img src="${post.imageUrl}" alt="" loading="lazy"><div class="trend-lbl"><div>@${post.user}</div><div style="font-size:11px;opacity:.8">‚ù§Ô∏è ${fmt(post.likes?.length||0)}</div></div>`;
    cell.onclick = () => openLb(post.id); tg.appendChild(cell);
  });
}

// ‚îÄ‚îÄ‚îÄ HOBBIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildHobbyCards() {
  const hc = $('hobbyCards'); hc.innerHTML = '';
  HOBBIES.forEach(h => {
    const c = TAG_COLORS[h], cnt = allPosts.filter(p=>(p.tags||[]).includes(h)).length;
    const card = document.createElement('div'); card.className='hcard'; card.style.cssText=`background:linear-gradient(135deg,${c}33,${c}18);border-color:${c}33;color:#fff`;
    card.innerHTML=`<div class="hcard-icon">${HOBBY_ICONS[h]}</div><div class="hcard-name">${h}</div><div class="hcard-count">${cnt} post${cnt!==1?'s':''}</div>`;
    card.onclick = () => { switchTab('home'); selectedHobby=h; buildChips(); renderGrid(); }; hc.appendChild(card);
  });
}

// ‚îÄ‚îÄ‚îÄ RIGHT SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildRightSidebar() {
  const th = $('trendingHobbies'); th.innerHTML = '';
  [...HOBBIES].sort((a,b) => allPosts.filter(p=>(p.tags||[]).includes(b)).length - allPosts.filter(p=>(p.tags||[]).includes(a)).length).slice(0,6).forEach((h,i) => {
    const cnt = allPosts.filter(p=>(p.tags||[]).includes(h)).length;
    const div = document.createElement('div'); div.className='trend-tag';
    div.innerHTML=`<span class="tt-rank">${i+1}</span><span style="font-size:16px">${HOBBY_ICONS[h]}</span><span class="tt-name" style="color:${TAG_COLORS[h]}">#${h}</span><span class="tt-count">${cnt}</span>`;
    div.onclick = () => { switchTab('home'); selectedHobby=h; buildChips(); renderGrid(); }; th.appendChild(div);
  });
}

// ‚îÄ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderProfilePage() {
  if (!currentUser||!currentProfile) return;
  $('profilePic').src       = currentProfile.avatar || '';
  $('profileName').textContent  = '@' + currentProfile.username;
  $('profileHandle').textContent= currentProfile.name || 'Hobby Enthusiast';
  $('profileBio').textContent   = currentProfile.bio  || '';
  const myPosts = allPosts.filter(p => p.uid===currentUser.uid);
  $('profilePostCount').textContent = myPosts.length;
  $('profileTags').innerHTML = [...new Set(myPosts.flatMap(p=>p.tags||[]))].map(t=>`<span class="ptag" style="background:${TAG_COLORS[t]||'#888'}cc">#${t}</span>`).join('');
  const grid = $('profileGrid'), empty = $('profileEmpty');
  grid.innerHTML = '';
  if (!myPosts.length) { empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');
  myPosts.forEach(post => {
    const cell = document.createElement('div'); cell.className='grid-cell';
    const dot = (post.tags&&post.tags[0]) ? TAG_COLORS[post.tags[0]] : '#FF6B6B';
    cell.innerHTML=`<img src="${post.imageUrl}" alt="" loading="lazy"><div class="grid-overlay"><span class="grid-stat">‚ù§Ô∏è ${fmt(post.likes?.length||0)}</span><span class="grid-stat">üí¨ ${post.comments?.length||0}</span></div><div class="grid-dot" style="background:${dot}"></div>`;
    cell.onclick = () => openLb(post.id); grid.appendChild(cell);
  });
}

// Change profile photo
$('changePhotoBtn').onclick = () => $('avatarInput').click();
$('profilePic').onclick     = () => $('avatarInput').click();
$('avatarInput').onchange   = async function() {
  const file = this.files[0]; if (!file||!currentUser) return;
  toast('Uploading photo...');
  try {
    const ref  = sRef(storage, `avatars/${currentUser.uid}/${Date.now()}`);
    const snap = await uploadBytesResumable(ref, file);
    const url  = await getDownloadURL(snap.ref);
    await updateDoc(doc(db,'users',currentUser.uid), { avatar: url });
    await updateProfile(currentUser, { photoURL: url });
    currentProfile.avatar = url;
    $('profilePic').src = $('sidebarAva').src = $('lbMyAva').src = url;
    toast('Profile photo updated! üéâ');
  } catch(e) { console.error(e); toast('Upload failed ‚Äî check Storage rules'); }
};

// Edit profile
$('editProfileBtn').onclick   = openEditProfile;
$('editProfileClose').onclick = () => closeModal('editProfileModal');
function openEditProfile() {
  $('editName').value = currentProfile.name || '';
  $('editBio').value  = currentProfile.bio  || '';
  const tg = $('editTagGrid'); tg.innerHTML = '';
  HOBBIES.forEach(h => {
    const c = TAG_COLORS[h], sel = (currentProfile.hobbies||[]).includes(h);
    const btn = document.createElement('button'); btn.className='tpick'; btn.textContent=h;
    btn.style.cssText = sel ? `background:${c};border:1px solid ${c};color:#fff` : `background:${c}18;border:1px solid ${c}55;color:${c}`;
    btn.onclick = () => {
      if (!currentProfile.hobbies) currentProfile.hobbies=[];
      const idx = currentProfile.hobbies.indexOf(h);
      idx>-1 ? currentProfile.hobbies.splice(idx,1) : currentProfile.hobbies.push(h);
      openEditProfile();
    };
    tg.appendChild(btn);
  });
  openModal('editProfileModal');
}
$('saveProfileBtn').onclick = async () => {
  if (!currentUser) return;
  currentProfile.name = $('editName').value.trim() || currentProfile.name;
  currentProfile.bio  = $('editBio').value.trim();
  try {
    await updateDoc(doc(db,'users',currentUser.uid), { name: currentProfile.name, bio: currentProfile.bio, hobbies: currentProfile.hobbies||[] });
    closeModal('editProfileModal'); renderProfilePage(); toast('Profile saved! ‚úÖ');
  } catch(e) { toast('Could not save profile'); }
};

// ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('toggle-row-privateAccount').onclick = () => toggleSetting('privateAccount');
$('toggle-row-contentFilter').onclick  = () => toggleSetting('contentFilter');
function toggleSetting(key) { settings[key]=!settings[key]; $('toggle-'+key).classList.toggle('on',settings[key]); toast((settings[key]?'Enabled':'Disabled')+': '+key.replace(/([A-Z])/g,' $1').trim().toLowerCase()); }

// Logout
$('logoutBtn').onclick = async () => { await signOut(auth); toast('Logged out üëã'); };

// Delete account
$('deleteAccBtn').onclick = () => {
  $('confirmTitle').textContent = 'Delete Account';
  $('confirmMsg').textContent   = 'This permanently deletes your account. This cannot be undone.';
  $('confirmOkBtn').textContent = 'Delete My Account';
  $('confirmOkBtn').onclick = async () => {
    closeModal('confirmModal');
    try { await deleteUser(currentUser); }
    catch(e) { toast('Please log out and log back in, then try again.'); }
  };
  openModal('confirmModal');
};
$('confirmClose').onclick  = () => closeModal('confirmModal');
$('confirmCancelBtn').onclick = () => closeModal('confirmModal');

// ‚îÄ‚îÄ‚îÄ UPLOAD POST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildTagGrid() {
  const tg = $('tagGrid'); if (!tg) return; tg.innerHTML='';
  HOBBIES.forEach(h => {
    const c=TAG_COLORS[h], sel=newPostTags.includes(h);
    const btn=document.createElement('button'); btn.className='tpick'; btn.textContent=h;
    btn.style.cssText = sel ? `background:${c};border:1px solid ${c};color:#fff` : `background:${c}18;border:1px solid ${c}55;color:${c}`;
    btn.onclick = () => { newPostTags.includes(h) ? (newPostTags=newPostTags.filter(t=>t!==h)) : newPostTags.push(h); buildTagGrid(); };
    tg.appendChild(btn);
  });
}

function openUploadModal() {
  newPostTags=[]; newPostFile=null; buildTagGrid();
  $('previewImg').style.display='none'; $('previewImg').src='';
  $('pickerHint').style.display='';
  $('captionInput').value='';
  $('btnShare').disabled=true;
  $('progressWrap').style.display='none';
  $('progressBar').style.width='0%';
  openModal('uploadModal');
}
$('uploadClose').onclick = () => { closeModal('uploadModal'); };
$('uploadModal').addEventListener('click', e => { if (e.target===$('uploadModal')) closeModal('uploadModal'); });

$('imgPicker').onclick = () => $('fileInput').click();
$('fileInput').onchange = function() {
  const file = this.files[0]; if (!file) return;
  newPostFile = file;
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image(); img.onload = () => {
      const canvas = document.createElement('canvas');
      const MAX=1080; let w=img.width, h=img.height;
      if (w>MAX) { h=Math.round(h*MAX/w); w=MAX; }
      if (h>MAX) { w=Math.round(w*MAX/h); h=MAX; }
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      const prev=$('previewImg'); prev.src=canvas.toDataURL('image/jpeg',0.85); prev.style.display='block';
      $('pickerHint').style.display='none';
      $('btnShare').disabled=false;
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
};

$('btnShare').onclick = async () => {
  if (!newPostFile||!currentUser||!currentProfile) return;
  const btn=$('btnShare');
  btn.disabled=true; btn.innerHTML='<span class="spin"></span>Uploading...';
  $('progressWrap').style.display='block';
  try {
    const path = `posts/${currentUser.uid}/${Date.now()}_${newPostFile.name}`;
    const ref  = sRef(storage, path);
    const task = uploadBytesResumable(ref, newPostFile);
    const imageUrl = await new Promise((resolve, reject) => {
      task.on('state_changed',
        s => { $('progressBar').style.width = Math.round(s.bytesTransferred/s.totalBytes*100)+'%'; },
        reject,
        async () => resolve(await getDownloadURL(task.snapshot.ref))
      );
    });
    await addDoc(collection(db,'posts'), {
      uid: currentUser.uid, user: currentProfile.username, avatar: currentProfile.avatar,
      imageUrl, caption: $('captionInput').value.trim(),
      tags: [...newPostTags], likes:[], comments:[], saved:[],
      timeAgo: 'Just now', createdAt: serverTimestamp()
    });
    closeModal('uploadModal');
    switchTab('home');
    toast('Post shared! üéâ');
  } catch(e) {
    console.error(e);
    toast('Upload failed ‚Äî check Firebase Storage rules');
  }
  btn.disabled=false; btn.innerHTML='Share Post';
};

// ‚îÄ‚îÄ‚îÄ CONFIRM MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// (wired above inline)
</script>
</body>
</html>
